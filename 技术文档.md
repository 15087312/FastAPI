# FastAPI Mall 库存微服务 - 技术文档

## 📋 项目概述

一个专业的、生产级的库存微服务，能够在多平台、高并发环境下安全管理库存，防止超卖，支持微服务化架构。

### 核心特性
- ✅ **防超卖机制**：基于 PostgreSQL 行级锁和 Redis 分布式锁
- ✅ **高性能缓存**：Redis 缓存层加速读取操作
- ✅ **三层调用架构**：API / Celery / CLI 多种调用方式
- ✅ **完整审计日志**：所有操作都有详细日志记录
- ✅ **幂等性保证**：通过 Redis 实现请求去重
- ✅ **优雅降级**：Redis 故障时自动降级到纯数据库模式

## 🏗️ 系统架构

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   API Layer │    │ Service     │    │  Data Layer │
│  (FastAPI)  │───▶│   Layer     │───▶│ (PostgreSQL)│
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Cache     │    │ Distributed │    │   Storage   │
│  (Redis)    │◀──▶│    Lock     │    │  (Models)   │
└─────────────┘    └─────────────┘    └─────────────┘
```

## 📁 目录结构

```
FastAPI_mall/
├── app/                    # 核心应用代码
│   ├── core/              # 核心配置
│   │   ├── config.py      # 应用配置
│   │   ├── dependencies.py # 依赖注入
│   │   └── redis.py       # Redis 配置
│   ├── db/                # 数据库相关
│   │   ├── session.py     # 数据库会话
│   │   └── base.py        # 基础模型
│   ├── models/            # 数据模型
│   │   ├── product.py     # 商品模型
│   │   ├── product_stocks.py # 库存模型
│   │   └── ...            # 其他模型
│   ├── services/          # 业务逻辑层
│   │   └── inventory_service.py # 库存服务
│   ├── routers/           # API 路由
│   │   └── inventory_router.py # 库存路由
│   └── jobs/              # 本地任务
│       └── manual_cleanup.py # 清理脚本
├── tasks/                 # 异步任务
│   ├── inventory_tasks.py # 库存相关任务
│   └── cleanup_tasks.py   # 清理任务
├── alembic/               # 数据库迁移
├── docker-compose.yml     # Docker 编排
├── requirements.txt       # Python 依赖
├── .env.example          # 环境变量模板
└── README.md             # 项目说明
```

## 🔧 核心组件说明

### 1. InventoryService（库存服务）
```python
class InventoryService:
    def __init__(self, db: Session, redis: Redis = None, rlock: Redlock = None)
    
    # 读操作（带缓存）
    def get_product_stock(self, product_id: int) -> int
    def batch_get_stocks(self, product_ids: List[int]) -> dict
    
    # 写操作（带分布式锁）
    def reserve_stock(self, product_id: int, quantity: int, order_id: str) -> bool
    def confirm_stock(self, order_id: str) -> bool
    def release_stock(self, order_id: str) -> bool
    
    # 维护操作
    def cleanup_expired_reservations(self, batch_size: int = 500) -> int
```

### 2. 缓存策略
- **读缓存**：5分钟TTL，key格式 `stock:available:{product_id}`
- **写失效**：任何库存变更后立即删除对应缓存
- **批量操作**：使用 Redis pipeline 优化性能

### 3. 分布式锁机制
- **Redlock**：跨实例分布式锁，10秒TTL
- **锁粒度**：按 `product_id` 粒度加锁
- **异常处理**：确保锁一定会被释放

## 🚀 部署指南

### 开发环境部署
```bash
# 1. 克隆项目
git clone <repository-url>
cd FastAPI_mall

# 2. 创建环境变量
cp .env.example .env
# 编辑 .env 文件配置

# 3. 启动基础服务
docker compose up -d

# 4. 安装 Python 依赖
pip install -r requirements.txt

# 5. 启动应用
uvicorn app.main:app --reload
```

### 生产环境部署
```bash
# 推荐使用 Docker 部署
docker build -t inventory-service .
docker run -d --name inventory-service \
  -p 8000:8000 \
  --env-file .env \
  inventory-service
```

## 📊 API 接口文档

详细接口文档请参考 [api总览.md](./api总览.md)

### 核心接口示例：

#### 预占库存
```bash
POST /inventory/reserve
{
  "product_id": 1,
  "quantity": 2,
  "order_id": "ORD123"
}
```

#### 查询库存
```bash
GET /inventory/stock/1
```

#### 批量查询
```bash
POST /inventory/stock/batch
{
  "product_ids": [1, 2, 3]
}
```

## 🧪 测试与监控

### 性能测试建议
```bash
# 使用 wrk 进行压力测试
wrk -t12 -c400 -d30s http://localhost:8000/inventory/stock/1

# 并发测试脚本
python -m pytest tests/ -v
```

### 监控指标
- 缓存命中率
- 数据库查询响应时间
- Redis 连接数
- 锁竞争情况
- 内存使用情况

## 🔒 安全考虑

### 数据安全
- 数据库连接使用环境变量配置
- 敏感信息不提交到版本控制
- 定期备份数据库和 Redis 数据

### 访问控制
- API 接口建议添加认证授权
- 限制批量查询的数量
- 实施速率限制防止滥用

## 🛠️ 故障排除

### 常见问题

**1. Redis 连接失败**
```bash
# 检查 Redis 服务状态
docker compose logs redis

# 重启 Redis 服务
docker compose restart redis
```

**2. 数据库连接超时**
```bash
# 检查数据库连接
docker compose logs db

# 验证数据库配置
echo $DATABASE_URL
```

**3. 缓存不一致**
```bash
# 手动清理缓存
redis-cli FLUSHALL

# 或者重启 Redis 服务
docker compose restart redis
```

## 📈 性能优化建议

### 数据库优化
- 为频繁查询的字段添加索引
- 定期分析和优化慢查询
- 考虑读写分离架构

### 缓存优化
- 调整缓存 TTL 时间
- 监控缓存命中率
- 考虑使用 Redis 集群

### 应用优化
- 实施连接池管理
- 优化批量处理大小
- 添加异步处理能力

## 🤝 贡献指南

欢迎提交 Issue 和 Pull Request！

### 开发规范
- 遵循 PEP 8 代码风格
- 添加必要的单元测试
- 更新相关文档
- 使用有意义的提交信息

## 📄 许可证

MIT License

---

*最后更新：2026年2月*